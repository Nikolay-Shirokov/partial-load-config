# Частичная загрузка конфигурации 1С из файлов по коммиту git

## Описание

Скрипты для автоматической частичной загрузки конфигурации 1С:Предприятие из файлов, измененных в указанном git коммите.

### Возможности

- ✅ Получение списка измененных файлов из любого git коммита
- ✅ Автоматическая фильтрация файлов конфигурации (XML)
- ✅ **Поддержка BSL файлов** - автоматическое добавление XML объектов при изменении модулей
- ✅ Создание файла списка для частичной загрузки
- ✅ Выполнение команды `/LoadConfigFromFiles` с параметром `-partial`
- ✅ Поддержка обоих форматов выгрузки (Hierarchical/Plain)
- ✅ Подробное логирование процесса
- ✅ Режим отладки

## Файлы

1. **partial-load-config.cmd** - версия для Windows (cmd)
2. **partial-load-config.ps1** - версия для PowerShell

## Требования

- Git установлен и доступен в PATH
- Платформа 1С:Предприятие 8.3
- Конфигурация выгружена в файлы (с помощью `/DumpConfigToFiles`)
- Git репозиторий с историей изменений конфигурации

## Использование

### PowerShell (рекомендуется)

```powershell
# Базовый пример
.\partial-load-config.ps1 -CommitId "a3f5b21" -InfoBasePath "C:\Bases\MyBase"

# С аутентификацией
.\partial-load-config.ps1 -CommitId "HEAD~1" `
    -InfoBaseName "MyBase" `
    -UserName "Admin" `
    -Password "password"

# С нестандартным каталогом конфигурации (например, src вместо config)
.\partial-load-config.ps1 -CommitId "HEAD" `
    -InfoBasePath "C:\edt\IB\Эксперименты" `
    -ConfigDir "src" `
    -Format "Hierarchical"

# С явным указанием пути к платформе 1С
.\partial-load-config.ps1 -CommitId "HEAD" `
    -InfoBasePath "C:\Bases\MyBase" `
    -V8Path "C:\Program Files\1cv8\8.3.27.1859\bin\1cv8.exe" `
    -DebugMode
```

### CMD

```cmd
REM Базовый пример
partial-load-config.cmd a3f5b21 /ib "C:\Bases\MyBase"

REM С аутентификацией
partial-load-config.cmd HEAD~1 /ibname "MyBase" /n Admin /p password

REM С дополнительными параметрами
partial-load-config.cmd feature/new-report ^
    /ib "C:\Bases\Test" ^
    /configdir ".\src\conf" ^
    /format Hierarchical ^
    /debug
```

## Параметры

### Обязательные

| Параметр | Описание |
|----------|----------|
| `CommitId` | Идентификатор коммита git (хеш, ветка, HEAD~N и т.д.) |

### Параметры подключения к ИБ (один из двух обязателен)

| Параметр | Описание |
|----------|----------|
| `InfoBasePath` / `/ib` | Путь к файловой базе данных |
| `InfoBaseName` / `/ibname` | Имя базы из списка информационных баз |

### Дополнительные параметры

| Параметр | Значение по умолчанию | Описание |
|----------|----------------------|----------|
| `UserName` / `/n` | - | Имя пользователя 1С |
| `Password` / `/p` | - | Пароль пользователя |
| `ConfigDir` / `/configdir` | `config` | Каталог с выгруженной конфигурацией |
| `Format` / `/format` | `Hierarchical` | Формат: Hierarchical или Plain |
| `V8Path` / `/v8` | `1cv8.exe` | Путь к исполняемому файлу платформы (если не указан, ищется в PATH) |
| `OutFile` / `/out` | temp файл | Файл для вывода служебных сообщений |
| `DebugMode` / `/debug` | - | Включить режим отладки |

## Как это работает

1. **Получение списка файлов**
   ```bash
   git show --pretty="" --name-only <commit-id>
   ```

2. **Фильтрация файлов**
   - Проверяется, что файл находится в каталоге конфигурации
   - Для XML файлов - добавляются напрямую
   - **Для BSL файлов** - автоматически добавляется соответствующий XML объекта и все связанные файлы (модули, формы и т.д.)
   - Проверяется существование файла

3. **Создание файла списка**
   - Файлы записываются построчно
   - Пути указываются относительно каталога конфигурации

4. **Выполнение загрузки**
   ```cmd
   1cv8.exe DESIGNER /F "path\to\base" /LoadConfigFromFiles "config" 
            -listFile "load_list.txt" -Format Hierarchical -partial 
            -updateConfigDumpInfo /DisableStartupDialogs
   ```

## Примеры использования

### Загрузка изменений из последнего коммита

```powershell
.\partial-load-config.ps1 -CommitId "HEAD" -InfoBasePath "C:\Bases\Dev"
```

### Загрузка изменений из коммита 3 дня назад

```powershell
.\partial-load-config.ps1 -CommitId "HEAD@{3.days.ago}" -InfoBaseName "Production"
```

### Загрузка изменений из конкретной ветки

```powershell
.\partial-load-config.ps1 -CommitId "feature/new-module" -InfoBasePath "C:\Bases\Test"
```

### Загрузка с логированием в файл

```powershell
.\partial-load-config.ps1 -CommitId "a3f5b21" `
    -InfoBasePath "C:\Bases\MyBase" `
    -OutFile "C:\Logs\load_log.txt"
```

## Структура каталогов

Рекомендуемая структура проекта:

```
project/
├── config/                 # Выгруженная конфигурация
│   ├── Catalogs/
│   ├── Documents/
│   ├── Reports/
│   └── ...
├── partial-load-config.ps1
├── partial-load-config.cmd
└── README_partial_load.md
```

## Коды возврата

| Код | Описание |
|-----|----------|
| 0 | Успешное выполнение |
| 1 | Ошибка (неверные параметры, git ошибка, ошибка загрузки) |

## Отладка

При возникновении проблем используйте параметр `-DebugMode`:

```powershell
.\partial-load-config.ps1 -CommitId "HEAD" -InfoBasePath "C:\Bases\Test" -DebugMode
```

Это выведет:
- Параметры запуска
- Список найденных файлов
- Содержимое файла списка загрузки
- Полную командную строку 1cv8.exe
- Путь к временным файлам (не удаляются)

## Как работает поддержка BSL

Когда скрипт обнаруживает изменение в BSL файле (например, `src/Catalogs/Справочник1/Ext/ObjectModule.bsl`), он автоматически:

1. Определяет тип объекта (`Catalogs`) и его имя (`Справочник1`)
2. Добавляет в список загрузки XML объекта (`Catalogs/Справочник1.xml`)
3. Добавляет сам BSL файл
4. Рекурсивно добавляет все файлы из подкаталога `Ext` (включая формы, предопределенные данные и т.д.)

Это гарантирует корректную загрузку изменений в модулях объектов.

## Ограничения

1. Работает только с файлами формата XML/BSL (не с `.cf`, `.cfu`)
2. Требует предварительную выгрузку конфигурации в файлы
3. Не поддерживает расширения конфигурации
4. Загружает только измененные файлы и связанные с ними объекты (не обрабатывает удаленные)

## Расширение функциональности

### Загрузка изменений из диапазона коммитов

Можно модифицировать скрипт для загрузки всех изменений между двумя коммитами:

```bash
git diff --name-only <commit1>..<commit2>
```

### Поддержка расширений

Добавить параметр `-Extension`:

```powershell
$arguments += "-Extension", "`"MyExtension`""
```

### Автоматическое обновление БД

Добавить после загрузки:

```powershell
$arguments = @("DESIGNER", "/UpdateDBCfg")
# ... остальные параметры
```

## Устранение неполадок

### Ошибка: "git не найден"
Установите git и добавьте его в PATH

### Ошибка: "Каталог конфигурации не найден"
Проверьте параметр `-ConfigDir` и наличие каталога

### Ошибка: "No configuration files found for loading"
- Проверьте идентификатор коммита
- Убедитесь, что в коммите есть изменения XML или BSL файлов
- Проверьте путь к каталогу конфигурации (параметр `-ConfigDir`)

### Ошибка: "The system cannot find the file specified" при запуске 1cv8.exe
- Укажите полный путь к платформе через параметр `-V8Path`
- Пример: `-V8Path "C:\Program Files\1cv8\8.3.27.1859\bin\1cv8.exe"`

### Код возврата 1 от 1cv8.exe
Проверьте файл лога (`-OutFile` или временный файл)

## См. также

- [Документация 1С: Командная строка](https://its.1c.ru/)
- [Git документация](https://git-scm.com/doc)
- Параметр `/LoadConfigFromFiles` (строка 1070 в документации)

## История изменений

### Версия 2.0 (ноябрь 2024)
- ✅ Добавлена поддержка BSL файлов
- ✅ Автоматическое добавление XML объектов при изменении модулей
- ✅ Улучшенная обработка связанных файлов объектов
- ✅ Исправлен конфликт параметра `-Debug` с встроенным PowerShell параметром (переименован в `-DebugMode`)
- ✅ Интернационализация сообщений (English)

### Версия 1.0
- ✅ Базовая функциональность частичной загрузки
- ✅ Поддержка XML файлов конфигурации
- ✅ Режим отладки

## Автор

Скрипт создан для автоматизации процесса разработки конфигураций 1С с использованием git.

## Лицензия

Свободное использование